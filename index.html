<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaveMind Online Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { font-family: -apple-system, sans-serif; background-color: #1a1a1a; color: #fff; text-align: center; padding: 20px; user-select: none; }
        .card { background: #2d2d2d; padding: 20px; border-radius: 15px; max-width: 500px; margin: 0 auto; border-top: 5px solid #555; }
        .btn { background-color: #555; border: none; color: white; padding: 15px 0; width: 100%; border-radius: 50px; font-size: 16px; margin: 5px 0; cursor: pointer; font-weight: bold; transition: opacity 0.3s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: #777; }
        .btn-green { background-color: #4CAF50; }
        .btn-blue { background-color: #2196F3; }
        .btn-red { background-color: #F44336; }
        .hidden { display: none !important; }
        .big-number { font-size: 60px; font-weight: bold; color: #ffeb3b; margin: 20px 0; }
        
        input[type=range] { width: 100%; margin: 30px 0; cursor: pointer; }

        /* ãƒ­ãƒ“ãƒ¼ãƒ»ãƒãƒ¼ãƒ è¡¨ç¤º */
        .lobby-container { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px; }
        .team-column { flex: 1; background: #333; padding: 10px; border-radius: 8px; border-top: 3px solid #777; }
        .team-header { font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        .player-list { min-height: 50px; font-size: 13px; text-align: left; margin-bottom: 10px; }
        .p-item { padding: 4px 6px; border-radius: 4px; margin-bottom: 2px; background: rgba(255,255,255,0.1); display: flex; justify-content: space-between; }
        .p-me { border: 1px solid #fff; font-weight: bold; }
        
        .role-icon { font-size: 10px; padding: 2px 4px; border-radius: 4px; margin-left: 5px; }
        .badge-psychic { background: #ff9800; color: #000; }
        .my-team-badge { background: #555; padding: 5px 15px; border-radius: 20px; font-size: 12px; display: inline-block; margin-bottom: 10px; }

        .info-bar { background: #444; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
        .turn-indicator { font-size: 18px; font-weight: bold; margin-bottom: 5px; }

        /* çµæœå¼·èª¿è¡¨ç¤ºç”¨ */
        .result-box { background: #333; padding: 15px; border-radius: 8px; margin-top: 10px; }
        
        .score-msg { font-size: 18px; font-weight: bold; color: #fff; display: block; margin-bottom: 5px; }
        
        /* 0ç‚¹ã¨å¾—ç‚¹æ™‚ã§è‰²ã‚’å¤‰ãˆã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ */
        .score-pop { font-size: 45px; font-weight: bold; display: block; margin: 5px 0; line-height: 1; }
        .score-positive { color: #4CAF50; text-shadow: 0 0 15px rgba(76,175,80,0.6); }
        .score-zero { color: #888; } /* 0ç‚¹ã¯åœ°å‘³ã« */

        /* ãƒãƒ£ãƒ³ã‚¹çµæœ */
        .counter-res { font-size: 16px; margin-top: 15px; padding: 10px; border-radius: 8px; border: 1px solid #555; background: rgba(0,0,0,0.2); }
        .counter-success { border-color: #ffeb3b; background: rgba(255, 235, 59, 0.15); color: #fff; font-weight: bold; }
        .counter-fail { color: #aaa; }

        /* çµæœãƒãƒ¼ */
        .result-viz-container { position: relative; width: 100%; height: 60px; background-color: #444; border-radius: 8px; margin: 15px 0; overflow: hidden; }
        .zone { position: absolute; height: 100%; top: 0; opacity: 0.8; }
        .zone-2 { background-color: #4fc3f7; } .zone-3 { background-color: #ffd740; } .zone-4 { background-color: #ff6e40; }
        .guess-pin { position: absolute; top: 0; width: 4px; height: 100%; background-color: #fff; z-index: 10; box-shadow: 0 0 4px #000; transition: left 0.2s; }
        .target-pin { position: absolute; top: 0; width: 2px; height: 100%; background-color: #ffeb3b; z-index: 5; opacity: 0.5; border-left: 1px dashed #000; }

        /* ãƒ«ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ */
        .rule-btn { position: fixed; top: 15px; right: 15px; width: 36px; height: 36px; border-radius: 50%; background: #444; border: 2px solid #888; color: #fff; font-size: 18px; font-weight: bold; cursor: pointer; z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background: #2d2d2d; padding: 25px; border-radius: 15px; max-width: 500px; width: 100%; max-height: 85vh; overflow-y: auto; text-align: left; border: 1px solid #555; position: relative; color: #ddd; font-size: 14px; line-height: 1.6; }
        .modal-close-x { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        .rule-section { margin-bottom: 15px; }
        .rule-title { font-weight: bold; color: #4CAF50; margin-bottom: 5px; font-size: 16px; }
        .pt-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 12px; margin-right: 5px; color:#000; }
    </style>
</head>
<body>

    <button class="rule-btn" onclick="toggleRuleModal()">?</button>

    <div id="rule-modal" class="modal-overlay hidden" onclick="toggleRuleModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-close-x" onclick="toggleRuleModal()">Ã—</div>
            <h2 style="text-align:center; color:#fff; margin-top:0;">è©³ã—ã„ãƒ«ãƒ¼ãƒ«</h2>
            <div class="rule-section"><div class="rule-title">å‹åˆ©æ¡ä»¶</div><p>å…ˆã« <strong style="color:#ffeb3b;">10ç‚¹</strong> å–ã£ãŸãƒãƒ¼ãƒ ã®å‹åˆ©</p><p style="font-size:12px;">â€»åŒæ™‚ã«10ç‚¹ã‚’è¶…ãˆãŸå ´åˆã€ç‚¹æ•°ãŒé«˜ã„æ–¹ãŒå‹åˆ©ã€‚åŒç‚¹ã®å ´åˆã¯<strong style="color:#4CAF50;">ãƒãƒ£ãƒ³ã‚¹ã‚’å½“ã¦ãŸãƒãƒ¼ãƒ </strong>ãŒå‹åˆ©ã—ã¾ã™ã€‚</p></div>
            <div class="rule-section"><div class="rule-title">ã‚²ãƒ¼ãƒ ã®æµã‚Œ</div><ol style="padding-left: 20px;"><li>ãƒ­ãƒ“ãƒ¼ã§ãƒãƒ¼ãƒ åˆ†ã‘</li><li>è¦ªãŒãŠé¡Œ(æ•°å€¤)ã‚’ç¢ºèªã—ã€ãƒ’ãƒ³ãƒˆã‚’å‡ºã™</li><li>ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã¯ãƒ’ãƒ³ãƒˆã‚’å…ƒã«ä½ç½®ã‚’äºˆæƒ³ã™ã‚‹</li><li><strong>æ•µãƒãƒ¼ãƒ ã®ãƒãƒ£ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ³</strong><br>æ•µã¯æ­£è§£ãŒäºˆæƒ³ã‚ˆã‚Šã€Œå³(å¤§ãã„)ã€ã‹ã€Œå·¦(å°ã•ã„)ã€ã‹ã‚’å½“ã¦ã‚‹</li><li>æ­£è§£ç™ºè¡¨ï¼†å¾—ç‚¹è¨ˆç®—</li></ol></div>
            <div class="rule-section"><div class="rule-title">å¾—ç‚¹è¡¨</div><div style="margin-bottom:5px;"><span class="pt-badge" style="background:#ffeb3b;">5ç‚¹</span> <strong>å®Œå…¨ä¸€è‡´ (èª¤å·®0)</strong></div><div style="margin-bottom:5px;"><span class="pt-badge" style="background:#ff6e40;">4ç‚¹</span> èª¤å·® Â±2 ä»¥å†…</div><div style="margin-bottom:5px;"><span class="pt-badge" style="background:#ffd740;">3ç‚¹</span> èª¤å·® Â±5 ä»¥å†…</div><div style="margin-bottom:5px;"><span class="pt-badge" style="background:#4fc3f7;">2ç‚¹</span> èª¤å·® Â±8 ä»¥å†…</div><p style="font-size:12px; color:#aaa; margin-top:10px;">â€»0ã¨100ã¯ç¹‹ãŒã£ã¦ã„ã‚‹ãŸã‚ã€è¿‘ã„æ–¹ã®ãƒ«ãƒ¼ãƒˆã§åˆ¤å®šã•ã‚Œã¾ã™</p></div>
            <div class="rule-section"><div class="rule-title">æ•µãƒãƒ¼ãƒ ã®ãƒœãƒ¼ãƒŠã‚¹</div><p>å›ç­”ãƒãƒ¼ãƒ ã®äºˆæƒ³ã«å¯¾ã—ã€æ­£è§£ãŒã€Œå³ã€ã‹ã€Œå·¦ã€ã‹ã‚’å½“ã¦ã‚‹ã¨ <strong style="color:#4CAF50;">+1ç‚¹</strong> ç²å¾—ã§ãã¾ã™ï¼ˆå˜ç´”ãªå¤§å°æ¯”è¼ƒã§ã™ï¼‰</p></div>
            <div style="text-align:center; margin-top:20px;"><button class="btn" style="padding:10px 30px; font-size:14px;" onclick="toggleRuleModal()">é–‰ã˜ã‚‹</button></div>
        </div>
    </div>

    <div id="screen-login" class="card">
        <h1>Wavelength Online</h1>
        <div style="margin-bottom: 20px;">
            <p>åå‰ã‚’å…¥åŠ›</p>
            <input type="text" id="input-name" placeholder="ã‚ãªãŸã®åå‰" style="padding:10px; font-size:16px; width:80%; text-align:center; margin-bottom:10px;">
            <p>åˆè¨€è‘‰ (éƒ¨å±‹ID)</p>
            <input type="text" id="input-room" placeholder="ä¾‹: 0119" style="padding:10px; font-size:16px; width:80%; text-align:center;">
        </div>
        <button id="btn-login" class="btn btn-green" onclick="connectToRoom()">ãƒ­ãƒ“ãƒ¼ã¸å…¥å®¤</button>
    </div>

    <div id="screen-game" class="card hidden">
        <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa; margin-bottom:5px;">
            <span>Room: <span id="display-room-id" style="color:#fff;"></span></span>
            <span id="connection-status">æ¥ç¶šä¸­...</span>
        </div>

        <div id="my-status-area"><span class="my-team-badge">è¦³æˆ¦ä¸­</span></div>

        <div class="lobby-container">
            <div class="team-column" style="border-top-color: #2196F3;">
                <div class="team-header">TEAM A (<span id="count-a">0</span>)</div>
                <div id="list-a" class="player-list"></div>
                <button class="btn btn-blue" style="font-size:12px;" onclick="joinTeam('A')">Aã«å‚åŠ </button>
                <div style="font-size:20px; font-weight:bold; margin-top:5px;" id="score-a">0</div>
            </div>
            <div class="team-column" style="border-top-color: #F44336;">
                <div class="team-header">TEAM B (<span id="count-b">0</span>)</div>
                <div id="list-b" class="player-list"></div>
                <button class="btn btn-red" style="font-size:12px;" onclick="joinTeam('B')">Bã«å‚åŠ </button>
                <div style="font-size:20px; font-weight:bold; margin-top:5px;" id="score-b">0</div>
            </div>
        </div>

        <div id="game-info-bar" class="info-bar hidden">
            <div id="info-round" style="font-size:12px; color:#aaa;">ROUND 1</div>
            <div id="info-turn" class="turn-indicator">TEAM A ã®ã‚¿ãƒ¼ãƒ³</div>
            <div id="info-psychic" style="font-size:14px;">è¦ª: ???</div>
        </div>

        <div id="phase-waiting" class="hidden">
            <p style="color:#aaa; font-size:14px; margin:20px 0;">ãƒãƒ¼ãƒ åˆ†ã‘ã‚’ã—ã¦<br>ã€Œã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
            <button class="btn btn-green" onclick="startNewRound(true)">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>

        <div id="phase-psychic" class="hidden">
            <div id="view-psychic-active" class="hidden">
                <div style="background:#ff9800; color:#000; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <h2 style="margin:0; font-size:20px;">ã‚ãªãŸãŒè¦ªã§ã™ï¼</h2>
                    <p style="margin:5px 0 0 0; font-size:12px;">æ•°å€¤ã‚’ç¢ºèªã—ã¦ãƒ’ãƒ³ãƒˆã‚’å‡ºã—ã¦ãã ã•ã„</p>
                </div>
                <p>ä»Šå›ã®ãŠé¡Œ(æ•°å€¤)</p>
                <div class="big-number" id="secret-target">??</div>
                <button class="btn" onclick="nextPhase('GUESS')">ãƒ’ãƒ³ãƒˆã‚’å‡ºã—ãŸ (å›ç­”ã¸)</button>
            </div>
            <div id="view-psychic-wait">
                <p id="msg-psychic-wait" style="font-size:16px;">è¦ªãŒãƒ’ãƒ³ãƒˆã‚’è€ƒãˆã¦ã„ã¾ã™...</p>
                <div class="big-number" style="font-size:40px; color:#555;">SECRET</div>
            </div>
        </div>

        <div id="phase-guess" class="hidden">
            <div id="slider-msg" style="font-size:12px; color:#aaa;"></div>
            <div class="big-number" id="guess-display">50</div>
            <input type="range" id="slider" min="0" max="100" value="50" oninput="onSliderChange(this.value)" onchange="onSliderChange(this.value)">
            <button id="btn-submit-guess" class="btn hidden" onclick="nextPhase('COUNTER')">äºˆæƒ³ã‚’ç¢ºå®šã™ã‚‹</button>
        </div>

        <div id="phase-counter" class="hidden">
            <p style="font-size:18px;">æ•µãƒãƒ¼ãƒ ã®ãƒãƒ£ãƒ³ã‚¹ï¼</p>
            <p style="font-size:14px; color:#aaa;">æ­£è§£ã¯äºˆæƒ³(<span id="locked-guess" style="color:#fff; font-weight:bold;"></span>)ã‚ˆã‚Š...</p>
            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button id="btn-left" class="btn hidden" style="width:48%" onclick="submitCounter('Left')">â¬…ï¸ å·¦ (å°ã•ã„)</button>
                <button id="btn-right" class="btn hidden" style="width:48%" onclick="submitCounter('Right')">å³ â¡ï¸ (å¤§ãã„)</button>
            </div>
            <p id="counter-wait-msg" style="font-size:12px; color:#aaa; margin-top:10px;">æ•µãƒãƒ¼ãƒ ã®æ“ä½œå¾…ã¡...</p>
        </div>

        <div id="phase-result" class="hidden">
            <h2>çµæœç™ºè¡¨</h2>
            <div class="result-viz-container" id="viz-bar"></div>
            
            <div class="result-box">
                <div id="res-main-result"></div>
                <div id="res-counter-result"></div>
            </div>

            <button class="btn btn-green" style="margin-top:15px;" onclick="startNewRound()">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸</button>
        </div>

        <div id="phase-win" class="hidden">
            <h1>WINNER!</h1>
            <div style="font-size:80px; margin:20px 0;">ğŸ†</div>
            <h2 id="winner-name">TEAM A</h2>
            <button class="btn btn-red" onclick="startNewRound(true)">ãƒªã‚»ãƒƒãƒˆã—ã¦å†æˆ¦</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDTnNp8ObeesaXjjBQqlC1MPLPh8V5SfPM",
            authDomain: "wavelength-online-2c27b.firebaseapp.com",
            databaseURL: "https://wavelength-online-2c27b-default-rtdb.firebaseio.com",
            projectId: "wavelength-online-2c27b",
            storageBucket: "wavelength-online-2c27b.firebasestorage.app",
            messagingSenderId: "1057840306391",
            appId: "1:1057840306391:web:432e632f9af1f286643892"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myId = localStorage.getItem('wl_uid');
        if (!myId) {
            myId = Math.random().toString(36).substring(2, 15);
            localStorage.setItem('wl_uid', myId);
        }

        let myName = "";
        let myTeam = ""; 
        let roomId = "";
        let gameState = {};
        
        const WIN_SCORE = 10;
        const RANGES = { w4: 2, w3: 5, w2: 8 };
        const TEAM_CONF = { A: {color:"#2196F3", name:"TEAM A"}, B: {color:"#F44336", name:"TEAM B"} };

        function connectToRoom() {
            const name = document.getElementById('input-name').value;
            const room = document.getElementById('input-room').value;
            if (!name || !room) return alert("åå‰ã¨éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const loginBtn = document.getElementById('btn-login');
            loginBtn.disabled = true;
            loginBtn.innerText = "æ¥ç¶šä¸­...";

            myName = name;
            roomId = "wl_room_" + room;
            document.getElementById('display-room-id').innerText = room;
            
            db.ref(`${roomId}/players/${myId}`).update({
                name: myName,
                online: true
            })
            .then(() => {
                db.ref(`${roomId}/players/${myId}/online`).onDisconnect().remove();
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('screen-game').classList.remove('hidden');
                
                db.ref(roomId).on('value', snapshot => {
                    const data = snapshot.val();
                    if (data) {
                        gameState = data;
                        renderGame();
                    } else {
                        gameState = { phase: 'WAITING', players: {} };
                        renderGame();
                    }
                });
            })
            .catch((error) => {
                alert("ã‚¨ãƒ©ãƒ¼ï¼šæ¥ç¶šã§ãã¾ã›ã‚“ã€‚\n" + error.message);
                loginBtn.disabled = false;
                loginBtn.innerText = "ãƒ­ãƒ“ãƒ¼ã¸å…¥å®¤";
            });
        }

        function toggleRuleModal() {
            const modal = document.getElementById('rule-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function joinTeam(team) {
            myTeam = team;
            db.ref(`${roomId}/players/${myId}`).update({ team: team, name: myName })
            .catch(e => alert("ãƒãƒ¼ãƒ å‚åŠ ã‚¨ãƒ©ãƒ¼: " + e.message));
        }

        function startNewRound(fullReset = false) {
            const players = gameState.players || {};
            let scores = { A: 0, B: 0 };
            let round = 1;
            let nextTeam = 'A';

            if (!fullReset && gameState.scores) {
                scores = gameState.scores;
                round = gameState.round + 1;
                nextTeam = gameState.currentTeam === 'A' ? 'B' : 'A';
            } else {
                nextTeam = Math.random() < 0.5 ? 'A' : 'B';
            }

            const teamMembers = Object.keys(players).filter(uid => {
                const p = players[uid];
                return p.team === nextTeam && p.online; 
            });
            
            if (teamMembers.length === 0) {
                return alert(`${TEAM_CONF[nextTeam].name} ã«ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“ï¼\nãƒãƒ¼ãƒ åˆ†ã‘ã‚’ã—ã¦ã‹ã‚‰é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`);
            }

            const psychicId = teamMembers[Math.floor(Math.random() * teamMembers.length)];

            db.ref(roomId).update({
                phase: 'PSYCHIC',
                currentTeam: nextTeam,
                psychicId: psychicId,
                target: Math.floor(Math.random() * 101),
                guess: 50,
                scores: scores,
                round: round,
                counterGuess: null,
                resultData: null,
                winner: null
            });
        }

        function onSliderChange(val) {
            if (gameState.phase !== 'GUESS') return;
            if (gameState.currentTeam === myTeam && gameState.psychicId !== myId) {
                db.ref(roomId).update({ guess: parseInt(val) });
            }
        }

        function nextPhase(next) {
            if (next === 'GUESS' && myId !== gameState.psychicId) return;
            if (next === 'COUNTER') {
                 if (myTeam !== gameState.currentTeam || myId === gameState.psychicId) return;
            }
            db.ref(roomId).update({ phase: next });
        }

        function submitCounter(direction) {
            if (myTeam === gameState.currentTeam) return; 

            const target = Number(gameState.target);
            const guess = Number(gameState.guess);
            const active = gameState.currentTeam;
            const inactive = active === 'A' ? 'B' : 'A';

            let diff = Math.abs(target - guess);
            let finalDiff = Math.min(diff, 100 - diff);

            // ãƒ¡ã‚¤ãƒ³ã‚¹ã‚³ã‚¢è¨ˆç®—
            let activePts = 0;
            let activeMsg = "å¤±æ•—...";
            if (finalDiff === 0) { activePts = 5; activeMsg = "å¥‡è·¡ã®å®Œå…¨ä¸€è‡´!!"; }
            else if (finalDiff <= RANGES.w4) { activePts = 4; activeMsg = "ç´ æ™´ã‚‰ã—ã„ï¼"; }
            else if (finalDiff <= RANGES.w3) { activePts = 3; activeMsg = "ãŠã—ã„"; }
            else if (finalDiff <= RANGES.w2) { activePts = 2; activeMsg = "ã‚®ãƒªã‚®ãƒª"; }

            // æ•µãƒãƒ¼ãƒ åˆ¤å®š (å˜ç´”å¤§å°)
            let inactivePts = 0;
            let counterStr = direction === 'Right' ? 'å³' : 'å·¦';
            let trueDir = target > guess ? 'Right' : 'Left';

            if (finalDiff === 0) {
                 counterStr = "ã‚¹ã‚­ãƒƒãƒ—";
            } else if (direction === trueDir) {
                inactivePts = 1;
                counterStr += " â†’ æ­£è§£! (+1)";
            } else {
                counterStr += " â†’ ãƒã‚ºãƒ¬";
            }

            // ã‚¹ã‚³ã‚¢æ›´æ–°
            let newScores = { ...gameState.scores };
            newScores[active] += activePts;
            newScores[inactive] += inactivePts;

            // â˜… å‹åˆ©åˆ¤å®š (åŒç‚¹æ™‚ã®ãƒ«ãƒ¼ãƒ«é©ç”¨) â˜…
            let winner = null;
            let nextPhaseVal = 'RESULT';

            if (newScores.A >= WIN_SCORE || newScores.B >= WIN_SCORE) {
                nextPhaseVal = 'WIN';
                if (newScores.A > newScores.B) {
                    winner = 'TEAM A';
                } else if (newScores.B > newScores.A) {
                    winner = 'TEAM B';
                } else {
                    // åŒç‚¹ã®å ´åˆã€ãƒãƒ£ãƒ³ã‚¹(inactive)å´ã®å‹ã¡
                    winner = TEAM_CONF[inactive].name;
                }
            }

            db.ref(roomId).update({
                scores: newScores,
                counterGuess: direction,
                resultData: { activePts, inactivePts, finalDiff, activeMsg, counterStr },
                phase: nextPhaseVal,
                winner: winner
            });
        }

        function renderGame() {
            const g = gameState;
            const players = g.players || {};

            document.getElementById('connection-status').innerText = "é€šä¿¡OK";
            const badge = document.querySelector('.my-team-badge');
            if (!myTeam) {
                badge.innerText = "è¦³æˆ¦ä¸­ (ãƒãƒ¼ãƒ ã«å‚åŠ ã—ã¦ãã ã•ã„)";
                badge.style.background = "#555";
            } else {
                badge.innerText = "ã‚ãªãŸã¯ " + TEAM_CONF[myTeam].name + " ã§ã™";
                badge.style.background = TEAM_CONF[myTeam].color;
            }

            const listA = document.getElementById('list-a');
            const listB = document.getElementById('list-b');
            listA.innerHTML = ""; listB.innerHTML = "";
            let countA = 0, countB = 0;

            Object.keys(players).forEach(uid => {
                const p = players[uid];
                if (!p.online) return; 

                const div = document.createElement('div');
                div.className = "p-item" + (uid === myId ? " p-me" : "");
                const nameSpan = document.createElement('span');
                nameSpan.innerText = p.name;
                div.appendChild(nameSpan);

                if (uid === g.psychicId && g.phase !== 'WAITING' && g.phase !== 'WIN') {
                    const icon = document.createElement('span');
                    icon.className = "role-icon badge-psychic";
                    icon.innerText = "è¦ª";
                    div.appendChild(icon);
                }

                if (p.team === 'A') { listA.appendChild(div); countA++; }
                else if (p.team === 'B') { listB.appendChild(div); countB++; }
            });
            document.getElementById('count-a').innerText = countA;
            document.getElementById('count-b').innerText = countB;
            document.getElementById('score-a').innerText = g.scores ? g.scores.A : 0;
            document.getElementById('score-b').innerText = g.scores ? g.scores.B : 0;

            ['waiting', 'psychic', 'guess', 'counter', 'result', 'win'].forEach(id => {
                document.getElementById('phase-' + id).classList.add('hidden');
            });

            const infoBar = document.getElementById('game-info-bar');

            if (!g.phase || g.phase === 'WAITING') {
                infoBar.classList.add('hidden');
                document.getElementById('phase-waiting').classList.remove('hidden');
                return;
            }

            infoBar.classList.remove('hidden');
            const tmConf = TEAM_CONF[g.currentTeam] || {name:"", color:"#fff"};
            const pName = players[g.psychicId] ? players[g.psychicId].name : "???";

            document.getElementById('info-round').innerText = `ROUND ${g.round}`;
            const turnEl = document.getElementById('info-turn');
            turnEl.innerText = `${tmConf.name} ã®ã‚¿ãƒ¼ãƒ³`;
            turnEl.style.color = tmConf.color;
            document.getElementById('info-psychic').innerText = `è¦ª: ${pName}`;

            const isActiveTeam = (myTeam === g.currentTeam);
            const isPsychic = (myId === g.psychicId);
            const isEnemy = (myTeam && !isActiveTeam);

            if (g.phase === 'PSYCHIC') {
                document.getElementById('phase-psychic').classList.remove('hidden');
                if (isPsychic) {
                    document.getElementById('view-psychic-active').classList.remove('hidden');
                    document.getElementById('view-psychic-wait').classList.add('hidden');
                    document.getElementById('secret-target').innerText = g.target;
                } else {
                    document.getElementById('view-psychic-active').classList.add('hidden');
                    document.getElementById('view-psychic-wait').classList.remove('hidden');
                    const msg = isActiveTeam ? `${pName}ã•ã‚“ãŒãŠé¡Œã‚’ç¢ºèªä¸­...` : `æ•µãƒãƒ¼ãƒ (${pName}ã•ã‚“)ãŒå‡ºé¡Œä¸­...`;
                    document.getElementById('msg-psychic-wait').innerText = msg;
                }
            } 
            else if (g.phase === 'GUESS') {
                document.getElementById('phase-guess').classList.remove('hidden');
                document.getElementById('guess-display').innerText = g.guess;
                const slider = document.getElementById('slider');
                slider.value = g.guess;
                slider.style.accentColor = tmConf.color;
                const submitBtn = document.getElementById('btn-submit-guess');
                const msg = document.getElementById('slider-msg');

                if (isActiveTeam && !isPsychic) {
                    slider.disabled = false;
                    submitBtn.classList.remove('hidden');
                    msg.innerText = "ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã—ã¦æ±ºå®šã—ã¦ãã ã•ã„";
                } else {
                    slider.disabled = true;
                    submitBtn.classList.add('hidden');
                    if(isPsychic) msg.innerText = "è¦ªã¯æ“ä½œã§ãã¾ã›ã‚“ï¼ˆç¥ˆã‚Šã¾ã—ã‚‡ã†ï¼‰";
                    else msg.innerText = "ç›¸æ‰‹ãƒãƒ¼ãƒ ãŒç›¸è«‡ä¸­...";
                }
            }
            else if (g.phase === 'COUNTER') {
                document.getElementById('phase-counter').classList.remove('hidden');
                const enemyConf = TEAM_CONF[g.currentTeam === 'A' ? 'B' : 'A'];
                document.getElementById('locked-guess').innerText = g.guess;
                turnEl.innerText = `${enemyConf.name} ã®ãƒãƒ£ãƒ³ã‚¹`;
                turnEl.style.color = enemyConf.color;

                if (isEnemy) {
                    document.getElementById('btn-left').classList.remove('hidden');
                    document.getElementById('btn-right').classList.remove('hidden');
                    document.getElementById('counter-wait-msg').classList.add('hidden');
                } else {
                    document.getElementById('btn-left').classList.add('hidden');
                    document.getElementById('btn-right').classList.add('hidden');
                    document.getElementById('counter-wait-msg').classList.remove('hidden');
                }
            }
            else if (g.phase === 'RESULT') {
                document.getElementById('phase-result').classList.remove('hidden');
                turnEl.innerText = "çµæœç™ºè¡¨";
                turnEl.style.color = "#fff";
                drawVisualResult(g.target, g.guess, tmConf.color);
                
                const rd = g.resultData || {};
                
                let html = `<div>æ­£è§£: <strong style="color:#ffeb3b; font-size:24px;">${g.target}</strong></div>`;
                
                // â˜… +0ç‚¹ã®å ´åˆã®è‰²å¤‰ãˆãƒ­ã‚¸ãƒƒã‚¯
                let mainColorClass = (rd.activePts > 0) ? "score-positive" : "score-zero";
                let mainBgColor = (rd.activePts > 0) ? `${tmConf.color}22` : "#333";
                let mainBorderColor = (rd.activePts > 0) ? tmConf.color : "#555";

                html += `
                    <div style="margin-top:10px; padding:15px; background:${mainBgColor}; border-left:5px solid ${mainBorderColor}; border-radius: 5px;">
                        <span class="score-msg" style="color:${(rd.activePts > 0 ? '#ffeb3b' : '#aaa')}">${rd.activeMsg}</span>
                        <span class="score-pop ${mainColorClass}">+${rd.activePts}ç‚¹</span>
                        <div style="font-size:12px; color:#ddd;">(æ‰‹ç•ª: ${tmConf.name})</div>
                    </div>
                `;

                // â˜… ãƒãƒ£ãƒ³ã‚¹çµæœã®å¼·èª¿
                let counterClass = (rd.inactivePts > 0) ? "counter-res counter-success" : "counter-res counter-fail";
                let counterEmoji = (rd.inactivePts > 0) ? "ğŸ¯" : "";

                html += `<div class="${counterClass}">${counterEmoji} ãƒãƒ£ãƒ³ã‚¹: <strong>${rd.counterStr}</strong></div>`;

                document.getElementById('res-main-result').innerHTML = html;
                document.getElementById('res-counter-result').innerHTML = ""; 
            }
            else if (g.phase === 'WIN') {
                document.getElementById('phase-win').classList.remove('hidden');
                infoBar.classList.add('hidden');
                
                // DBã«ä¿å­˜ã•ã‚ŒãŸå‹è€…ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°è¨ˆç®—
                let winnerName = g.winner;
                if (!winnerName) {
                    winnerName = g.scores.A >= WIN_SCORE ? 'TEAM A' : 'TEAM B';
                }
                
                // ãƒãƒ¼ãƒ ã‚«ãƒ©ãƒ¼åˆ¤å®š
                let wColor = "#fff";
                if(winnerName === 'TEAM A') wColor = TEAM_CONF.A.color;
                if(winnerName === 'TEAM B') wColor = TEAM_CONF.B.color;

                document.getElementById('winner-name').innerText = winnerName;
                document.getElementById('winner-name').style.color = wColor;
            }
        }

        function drawVisualResult(target, guess, color) {
            const container = document.getElementById('viz-bar');
            container.innerHTML = ''; 
            function createZone(w, cls) {
                let s = target - w, e = target + w;
                drawR(s, e, cls);
                if (s < 0) drawR(100+s, 100, cls);
                if (e > 100) drawR(0, e-100, cls);
            }
            function drawR(l, r, cls) {
                let div = document.createElement('div');
                div.className = 'zone ' + cls;
                div.style.left = Math.max(0,l)+'%'; div.style.width = (Math.min(100,r)-Math.max(0,l))+'%';
                container.appendChild(div);
            }
            createZone(8, 'zone-2'); createZone(5, 'zone-3'); createZone(2, 'zone-4');
            
            let pin = document.createElement('div');
            pin.className = 'guess-pin';
            pin.style.left = guess + '%';
            pin.style.backgroundColor = color;
            container.appendChild(pin);

            let tPin = document.createElement('div');
            tPin.className = 'target-pin';
            tPin.style.left = target + '%';
            container.appendChild(tPin);
        }
    </script>
</body>
</html>

