<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wavelength Online Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { font-family: -apple-system, sans-serif; background-color: #1a1a1a; color: #fff; text-align: center; padding: 20px; user-select: none; }
        .card { background: #2d2d2d; padding: 20px; border-radius: 15px; max-width: 500px; margin: 0 auto; border-top: 5px solid #555; }
        .btn { background-color: #555; border: none; color: white; padding: 15px 0; width: 100%; border-radius: 50px; font-size: 18px; margin: 10px 0; cursor: pointer; font-weight: bold; transition: opacity 0.3s; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-green { background-color: #4CAF50; }
        .btn-blue { background-color: #2196F3; }
        .btn-red { background-color: #F44336; }
        .hidden { display: none !important; }
        .big-number { font-size: 60px; font-weight: bold; color: #ffeb3b; margin: 20px 0; }
        
        input[type=range] { width: 100%; margin: 30px 0; cursor: pointer; }
        input[type=range]:disabled { cursor: not-allowed; opacity: 0.5; }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆè¡¨ç¤º */
        .player-list-container { display: flex; justify-content: space-between; margin-bottom: 15px; background: #333; border-radius: 8px; padding: 10px; }
        .team-box { width: 48%; }
        .team-title { font-size: 14px; font-weight: bold; margin-bottom: 5px; border-bottom: 2px solid; display: inline-block; padding: 0 5px; }
        .p-name { font-size: 13px; display: block; margin: 2px 0; color: #ddd; }
        .p-me { color: #ffeb3b; font-weight: bold; } /* è‡ªåˆ† */
        .p-psychic::after { content: " (è¦ª)"; color: #ff9800; font-size: 10px; } /* è¦ª */

        /* çµæœãƒãƒ¼ */
        .result-viz-container { position: relative; width: 100%; height: 60px; background-color: #444; border-radius: 8px; margin: 15px 0; overflow: hidden; }
        .zone { position: absolute; height: 100%; top: 0; opacity: 0.8; }
        .zone-2 { background-color: #4fc3f7; } .zone-3 { background-color: #ffd740; } .zone-4 { background-color: #ff6e40; }
        .guess-pin { position: absolute; top: 0; width: 4px; height: 100%; background-color: #fff; z-index: 10; box-shadow: 0 0 4px #000; transition: left 0.2s; }
        .target-pin { position: absolute; top: 0; width: 2px; height: 100%; background-color: #ffeb3b; z-index: 5; opacity: 0.5; border-left: 1px dashed #000; }

        /* ãƒ­ãƒ¼ãƒ«è¡¨ç¤ºãƒãƒƒã‚¸ */
        .role-badge { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; margin-bottom: 10px; color: #000; }
    </style>
</head>
<body>

    <div id="screen-login" class="card">
        <h1>Wavelength Online</h1>
        <div style="margin-bottom: 20px;">
            <p>åå‰ã‚’å…¥åŠ›</p>
            <input type="text" id="input-name" placeholder="ã‚ãªãŸã®åå‰" style="padding:10px; font-size:16px; width:80%; text-align:center; margin-bottom:10px;">
            <p>åˆè¨€è‘‰ (éƒ¨å±‹ID)</p>
            <input type="text" id="input-room" placeholder="ä¾‹: 0119" style="padding:10px; font-size:16px; width:80%; text-align:center;">
        </div>
        <button class="btn btn-green" onclick="login()">ã‚²ãƒ¼ãƒ ã«å‚åŠ </button>
    </div>

    <div id="screen-game" class="card hidden">
        <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa; margin-bottom:5px;">
            <span>Room: <span id="display-room-id" style="color:#fff;"></span></span>
            <span id="my-role-text">è¦³æˆ¦ä¸­</span>
        </div>

        <div class="player-list-container">
            <div class="team-box" style="border-right: 1px solid #444;">
                <div class="team-title" style="color:#2196F3;">TEAM A: <span id="score-a" style="font-size:16px;">0</span></div>
                <div id="list-a"></div>
            </div>
            <div class="team-box">
                <div class="team-title" style="color:#F44336;">TEAM B: <span id="score-b" style="font-size:16px;">0</span></div>
                <div id="list-b"></div>
            </div>
        </div>

        <p id="status-text" style="font-size:18px; font-weight:bold; color:#ffeb3b; min-height: 27px;">å¾…æ©Ÿä¸­...</p>

        <div id="phase-waiting" class="hidden">
            <p style="font-size:14px; color:#aaa;">ãƒ¡ãƒ³ãƒãƒ¼ãŒæƒã£ãŸã‚‰é–‹å§‹ã—ã¦ãã ã•ã„</p>
            <button class="btn btn-green" onclick="startNewRound(true)">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>

        <div id="phase-psychic" class="hidden">
            <div id="view-psychic-active">
                <span class="role-badge" style="background:#ff9800;">ã‚ãªãŸã¯è¦ªã§ã™</span>
                <p>æ•°å€¤ã‚’ç¢ºèªã—ã¦ãƒ’ãƒ³ãƒˆã‚’å‡ºã—ã¦ãã ã•ã„</p>
                <div class="big-number" id="secret-target">??</div>
                <button class="btn" onclick="nextPhase('GUESS')">ãƒ’ãƒ³ãƒˆã‚’å‡ºã—ãŸ (å›ç­”ã¸)</button>
            </div>
            <div id="view-psychic-wait">
                <p style="font-size:14px; color:#aaa;">ç¾åœ¨ã€è¦ªãŒãƒ’ãƒ³ãƒˆã‚’è€ƒãˆã¦ã„ã¾ã™...</p>
                <div class="big-number" style="font-size:40px; color:#555;">SECRET</div>
            </div>
        </div>

        <div id="phase-guess" class="hidden">
            <div id="slider-msg"></div>
            <div class="big-number" id="guess-display">50</div>
            
            <input type="range" id="slider" min="0" max="100" value="50" oninput="onSliderChange(this.value)" onchange="onSliderChange(this.value)">
            
            <button id="btn-submit-guess" class="btn" onclick="nextPhase('COUNTER')">äºˆæƒ³ã‚’ç¢ºå®šã™ã‚‹</button>
        </div>

        <div id="phase-counter" class="hidden">
            <p>æ•µãƒãƒ¼ãƒ ã®ãƒãƒ£ãƒ³ã‚¹ï¼<br>æ­£è§£ã¯äºˆæƒ³(<span id="locked-guess"></span>)ã‚ˆã‚Š...</p>
            
            <div style="display:flex; justify-content:space-between;">
                <button id="btn-left" class="btn" style="width:48%" onclick="submitCounter('Left')">â¬…ï¸ å·¦</button>
                <button id="btn-right" class="btn" style="width:48%" onclick="submitCounter('Right')">å³ â¡ï¸</button>
            </div>
            <p id="counter-wait-msg" style="font-size:12px; color:#aaa; margin-top:10px;">æ•µãƒãƒ¼ãƒ ã®æ“ä½œå¾…ã¡...</p>
        </div>

        <div id="phase-result" class="hidden">
            <div class="result-viz-container" id="viz-bar"></div>
            <div id="result-details" style="text-align:left; font-size:14px; line-height:1.6;"></div>
            <button class="btn btn-green" onclick="startNewRound()">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸</button>
        </div>

        <div id="phase-win" class="hidden">
            <h1>WINNER!</h1>
            <div style="font-size:60px;">ğŸ†</div>
            <h2 id="winner-name">TEAM A</h2>
            <button class="btn btn-red" onclick="startNewRound(true)">ãƒªã‚»ãƒƒãƒˆã—ã¦å†æˆ¦</button>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜… Firebaseè¨­å®š (å‰å›ã¨åŒã˜ã‚‚ã®) â˜…â˜…â˜…
        const firebaseConfig = {
            apiKey: "AIzaSyDxxxxxxxxxxxxxxxxxxxxxxxx",
            authDomain: "wavelength-xxxxx.firebaseapp.com",
            databaseURL: "https://wavelength-xxxxx-default-rtdb.firebaseio.com",
            projectId: "wavelength-xxxxx",
            storageBucket: "wavelength-xxxxx.appspot.com",
            messagingSenderId: "00000000000",
            appId: "1:00000000000:web:000000000000"
        };
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // è‡ªåˆ†ã®IDã‚’ç”Ÿæˆ (ãƒ–ãƒ©ã‚¦ã‚¶ã”ã¨ã«å›ºå®š)
        let myId = localStorage.getItem('wl_uid');
        if (!myId) {
            myId = Math.random().toString(36).substring(2, 15);
            localStorage.setItem('wl_uid', myId);
        }

        let myName = "";
        let myTeam = ""; // 'A' or 'B'
        let roomId = "";
        let gameState = {};
        
        const WIN_SCORE = 10;
        const RANGES = { w4: 2, w3: 5, w2: 8 };
        const TEAM_CONF = { A: {color:"#2196F3", name:"TEAM A"}, B: {color:"#F44336", name:"TEAM B"} };

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function login() {
            const name = document.getElementById('input-name').value;
            const room = document.getElementById('input-room').value;
            if (!name || !room) return alert("åå‰ã¨éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            myName = name;
            roomId = "wl_room_" + room;
            document.getElementById('display-room-id').innerText = room;

            // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿å–å¾—ã—ã¦ãƒãƒ¼ãƒ åˆ†ã‘
            db.ref(roomId).once('value', snapshot => {
                const data = snapshot.val() || {};
                const players = data.players || {};
                
                // ã™ã§ã«ç™»éŒ²æ¸ˆã¿ãªã‚‰ãã®ã¾ã¾ã€æ–°è¦ãªã‚‰ãƒãƒ¼ãƒ æŒ¯ã‚Šåˆ†ã‘
                if (players[myId]) {
                    myTeam = players[myId].team;
                } else {
                    // äººæ•°ãŒå°‘ãªã„ãƒãƒ¼ãƒ ã«å…¥ã‚‹
                    const countA = Object.values(players).filter(p => p.team === 'A').length;
                    const countB = Object.values(players).filter(p => p.team === 'B').length;
                    myTeam = countA <= countB ? 'A' : 'B';
                }

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç™»éŒ²
                db.ref(`${roomId}/players/${myId}`).set({
                    name: myName,
                    team: myTeam
                });

                // ç”»é¢é·ç§»
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('screen-game').classList.remove('hidden');
                
                // ç›£è¦–é–‹å§‹
                startListening();
            });
        }

        // DBç›£è¦–
        function startListening() {
            db.ref(roomId).on('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    gameState = data;
                    renderGame();
                } else {
                    // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆãŸå ´åˆãªã©
                    gameState = { phase: 'WAITING', players: {} };
                    renderGame();
                }
            });
        }

        // ã‚²ãƒ¼ãƒ é€²è¡Œ: æ–°ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹
        function startNewRound(fullReset = false) {
            let scores = { A: 0, B: 0 };
            let round = 1;
            let nextTeam = 'A';
            const players = gameState.players || {};

            if (!fullReset && gameState.scores) {
                scores = gameState.scores;
                round = gameState.round + 1;
                nextTeam = gameState.currentTeam === 'A' ? 'B' : 'A';
            } else {
                nextTeam = Math.random() < 0.5 ? 'A' : 'B';
            }

            // æ¬¡ã®ãƒãƒ¼ãƒ ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§è¦ªã‚’é¸ã¶
            const teamMembers = Object.keys(players).filter(uid => players[uid].team === nextTeam);
            let psychicId = null;
            if (teamMembers.length > 0) {
                psychicId = teamMembers[Math.floor(Math.random() * teamMembers.length)];
            }

            db.ref(roomId).update({
                phase: 'PSYCHIC',
                currentTeam: nextTeam,
                psychicId: psychicId,
                target: Math.floor(Math.random() * 101),
                guess: 50,
                scores: scores,
                round: round,
                counterGuess: null,
                resultData: null
            });
        }

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œ
        function onSliderChange(val) {
            // è¦ªã‚„æ•µãƒãƒ¼ãƒ ãŒæ“ä½œã—ã¦ã‚‚DBåæ˜ ã—ãªã„ã‚¬ãƒ¼ãƒ‰ã¯UIå´ã§è¡Œã†ãŒã€å¿µã®ãŸã‚
            if (gameState.phase !== 'GUESS') return;
            // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã‹ã¤ã€è‡ªåˆ†ã¯è¦ªã§ã¯ãªã„å ´åˆã®ã¿é€ä¿¡
            if (gameState.currentTeam === myTeam && gameState.psychicId !== myId) {
                db.ref(roomId).update({ guess: parseInt(val) });
            }
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºé€²è¡Œ
        function nextPhase(next) {
            // è¦ªã—ã‹æŠ¼ã›ãªã„ãƒœã‚¿ãƒ³ãªã©ã®ã‚¬ãƒ¼ãƒ‰
            if (next === 'GUESS') {
                if (myId !== gameState.psychicId) return;
            }
            if (next === 'COUNTER') {
                 // å›ç­”è€…ã—ã‹æŠ¼ã›ãªã„
                 if (myTeam !== gameState.currentTeam || myId === gameState.psychicId) return;

                // èª¤å·®0ã‚¹ã‚­ãƒƒãƒ—åˆ¤å®š (ãŸã ã—ã€Œèª¤å·®0ã§ã‚‚æ•µã‚¿ãƒ¼ãƒ³ã¸è¡Œãã€è¦æœ›ãŒã‚ã£ãŸãŸã‚å‰Šé™¤ã›ãšã«é€šéã•ã›ã‚‹)
                // ã‚‚ã—ã€Œçµæœãƒãƒ¬ã‚’é˜²ããŸã‚ã«ä¸€å¿œæ•µã‚¿ãƒ¼ãƒ³ã«è¡Œãã€ãªã‚‰ãã®ã¾ã¾COUNTERã¸
            }

            db.ref(roomId).update({ phase: next });
        }

        // ãƒãƒ£ãƒ³ã‚¹ï¼ˆå·¦å³å½“ã¦ï¼‰é€ä¿¡
        function submitCounter(direction) {
            // æ•µãƒãƒ¼ãƒ ã—ã‹æŠ¼ã›ãªã„
            if (myTeam === gameState.currentTeam) return;

            // çµæœè¨ˆç®—
            const target = gameState.target;
            const guess = gameState.guess;
            const active = gameState.currentTeam;
            const inactive = active === 'A' ? 'B' : 'A';

            let diff = Math.abs(target - guess);
            let finalDiff = Math.min(diff, 100 - diff);

            let activePts = 0;
            if (finalDiff === 0) activePts = 5;
            else if (finalDiff <= RANGES.w4) activePts = 4;
            else if (finalDiff <= RANGES.w3) activePts = 3;
            else if (finalDiff <= RANGES.w2) activePts = 2;

            let inactivePts = 0;
            let resultMsg = "";
            let counterResultStr = direction === 'Right' ? 'å³' : 'å·¦';

            if (finalDiff === 0) {
                resultMsg = "å®Œå…¨ä¸€è‡´ã®ãŸã‚ãƒœãƒ¼ãƒŠã‚¹ãªã—";
            } else {
                let d = target - guess;
                if (d > 50) d -= 100;
                if (d < -50) d += 100;
                let trueDir = d > 0 ? 'Right' : 'Left';
                
                if (direction === trueDir) {
                    inactivePts = 1;
                    resultMsg = "ãƒãƒ£ãƒ³ã‚¹æˆåŠŸï¼ (+1ç‚¹)";
                    counterResultStr += " â†’ æ­£è§£ï¼";
                } else {
                    resultMsg = "ãƒãƒ£ãƒ³ã‚¹å¤±æ•—...";
                    counterResultStr += " â†’ ãƒã‚ºãƒ¬";
                }
            }

            let newScores = { ...gameState.scores };
            newScores[active] += activePts;
            newScores[inactive] += inactivePts;

            db.ref(roomId).update({
                scores: newScores,
                counterGuess: direction,
                resultData: { activePts, inactivePts, finalDiff, msg: resultMsg, counterStr: counterResultStr },
                phase: (newScores.A >= WIN_SCORE || newScores.B >= WIN_SCORE) ? 'WIN' : 'RESULT'
            });
        }


        // â˜…â˜…â˜… æç”»ãƒ­ã‚¸ãƒƒã‚¯ (æ¨©é™ç®¡ç†ã®ã‚­ãƒ¢) â˜…â˜…â˜…
        function renderGame() {
            const g = gameState;
            if (!g.phase) { // ã¾ã å§‹ã¾ã£ã¦ãªã„
                document.getElementById('phase-waiting').classList.remove('hidden');
                return;
            } else {
                document.getElementById('phase-waiting').classList.add('hidden');
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°
            renderPlayerList(g.players || {});
            
            // ã‚¹ã‚³ã‚¢
            document.getElementById('score-a').innerText = g.scores ? g.scores.A : 0;
            document.getElementById('score-b').innerText = g.scores ? g.scores.B : 0;

            const tmConf = TEAM_CONF[g.currentTeam] || {name:"", color:"#fff"};
            const statusEl = document.getElementById('status-text');
            statusEl.style.color = tmConf.color;

            // ãƒ•ã‚§ãƒ¼ã‚ºåˆæœŸåŒ–
            ['psychic', 'guess', 'counter', 'result', 'win'].forEach(id => {
                document.getElementById('phase-' + id).classList.add('hidden');
            });

            // --- å½¹å‰²åˆ¤å®š ---
            const isActiveTeam = (myTeam === g.currentTeam);
            const isPsychic = (myId === g.psychicId);
            const isGuesser = (isActiveTeam && !isPsychic);
            const isEnemy = (!isActiveTeam);

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
            document.getElementById('my-role-text').innerText = 
                isPsychic ? "ã‚ãªãŸã¯è¦ªã§ã™" : (isGuesser ? "ã‚ãªãŸã¯å›ç­”è€…ã§ã™" : "æ•µãƒãƒ¼ãƒ ã®ã‚¿ãƒ¼ãƒ³");

            // --- ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥è¡¨ç¤º ---

            if (g.phase === 'PSYCHIC') {
                document.getElementById('phase-psychic').classList.remove('hidden');
                const psychicName = g.players && g.players[g.psychicId] ? g.players[g.psychicId].name : "è¦ª";
                statusEl.innerText = `${tmConf.name} (${psychicName}) ã®å‡ºé¡Œ`;

                if (isPsychic) {
                    document.getElementById('view-psychic-active').classList.remove('hidden');
                    document.getElementById('view-psychic-wait').classList.add('hidden');
                    document.getElementById('secret-target').innerText = g.target;
                } else {
                    document.getElementById('view-psychic-active').classList.add('hidden');
                    document.getElementById('view-psychic-wait').classList.remove('hidden');
                }

            } else if (g.phase === 'GUESS') {
                document.getElementById('phase-guess').classList.remove('hidden');
                statusEl.innerText = `${tmConf.name} ãŒç›¸è«‡ä¸­...`;
                document.getElementById('guess-display').innerText = g.guess;
                
                const slider = document.getElementById('slider');
                slider.value = g.guess;
                slider.style.accentColor = tmConf.color; // ãƒãƒ¼ãƒ ã‚«ãƒ©ãƒ¼

                // æ“ä½œæ¨©é™: å›ç­”è€…ã®ã¿æ“ä½œå¯èƒ½
                if (isGuesser) {
                    slider.disabled = false;
                    document.getElementById('btn-submit-guess').classList.remove('hidden');
                    document.getElementById('slider-msg').innerText = "ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã—ã¦äºˆæƒ³ã—ã¦ãã ã•ã„";
                } else {
                    slider.disabled = true;
                    document.getElementById('btn-submit-guess').classList.add('hidden');
                    document.getElementById('slider-msg').innerText = isPsychic ? "è¦ªã¯æ“ä½œã§ãã¾ã›ã‚“" : "æ•µãƒãƒ¼ãƒ ãŒæ“ä½œä¸­...";
                }

            } else if (g.phase === 'COUNTER') {
                document.getElementById('phase-counter').classList.remove('hidden');
                const enemyConf = TEAM_CONF[g.currentTeam === 'A' ? 'B' : 'A'];
                statusEl.innerText = `${enemyConf.name} ã®ãƒãƒ£ãƒ³ã‚¹ï¼`;
                statusEl.style.color = enemyConf.color;
                document.getElementById('locked-guess').innerText = g.guess;

                // æ“ä½œæ¨©é™: æ•µãƒãƒ¼ãƒ ã®ã¿
                if (isEnemy) {
                    document.getElementById('btn-left').classList.remove('hidden');
                    document.getElementById('btn-right').classList.remove('hidden');
                    document.getElementById('counter-wait-msg').classList.add('hidden');
                } else {
                    document.getElementById('btn-left').classList.add('hidden');
                    document.getElementById('btn-right').classList.add('hidden');
                    document.getElementById('counter-wait-msg').classList.remove('hidden');
                }

            } else if (g.phase === 'RESULT') {
                document.getElementById('phase-result').classList.remove('hidden');
                statusEl.innerText = "çµæœç™ºè¡¨";
                statusEl.style.color = "#fff";
                
                drawVisualResult(g.target, g.guess, tmConf.color);
                const rd = g.resultData || {};

                document.getElementById('result-details').innerHTML = `
                    <p>æ­£è§£: <strong style="color:#ffeb3b">${g.target}</strong> (èª¤å·® ${rd.finalDiff})</p>
                    <p>æ‰‹ç•ª: <strong>+${rd.activePts}ç‚¹</strong></p>
                    <p>ãƒãƒ£ãƒ³ã‚¹: ${rd.counterStr}</p>
                `;

            } else if (g.phase === 'WIN') {
                document.getElementById('phase-win').classList.remove('hidden');
                const winner = g.scores.A >= WIN_SCORE ? 'TEAM A' : 'TEAM B';
                document.getElementById('winner-name').innerText = winner;
                document.getElementById('winner-name').style.color = TEAM_CONF[winner.slice(-1)].color;
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆæç”»
        function renderPlayerList(players) {
            const listA = document.getElementById('list-a');
            const listB = document.getElementById('list-b');
            listA.innerHTML = "";
            listB.innerHTML = "";

            Object.keys(players).forEach(uid => {
                const p = players[uid];
                const isMe = (uid === myId);
                const isPsychic = (uid === gameState.psychicId);
                
                const span = document.createElement('span');
                span.className = "p-name" + (isMe ? " p-me" : "") + (isPsychic ? " p-psychic" : "");
                span.innerText = p.name;
                
                if (p.team === 'A') listA.appendChild(span);
                else listB.appendChild(span);
            });
        }

        // çµæœæç”»
        function drawVisualResult(target, guess, color) {
            const container = document.getElementById('viz-bar');
            container.innerHTML = ''; 
            function createZone(w, cls) {
                let s = target - w, e = target + w;
                drawR(s, e, cls);
                if (s < 0) drawR(100+s, 100, cls);
                if (e > 100) drawR(0, e-100, cls);
            }
            function drawR(l, r, cls) {
                let div = document.createElement('div');
                div.className = 'zone ' + cls;
                div.style.left = Math.max(0,l)+'%'; div.style.width = (Math.min(100,r)-Math.max(0,l))+'%';
                container.appendChild(div);
            }
            createZone(8, 'zone-2'); createZone(5, 'zone-3'); createZone(2, 'zone-4');
            
            let pin = document.createElement('div');
            pin.className = 'guess-pin';
            pin.style.left = guess + '%';
            pin.style.backgroundColor = color;
            container.appendChild(pin);

            let tPin = document.createElement('div');
            tPin.className = 'target-pin';
            tPin.style.left = target + '%';
            container.appendChild(tPin);
        }
    </script>
</body>
</html>
