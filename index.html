<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wavelength Online</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®šï¼ˆä»¥å‰ã¨åŒã˜ï¼‰ */
        body { font-family: sans-serif; background-color: #1a1a1a; color: #fff; text-align: center; padding: 20px; user-select: none; }
        .card { background: #2d2d2d; padding: 20px; border-radius: 15px; max-width: 500px; margin: 0 auto; border-top: 5px solid #555; }
        .btn { background-color: #555; border: none; color: white; padding: 15px 0; width: 100%; border-radius: 50px; font-size: 18px; margin: 10px 0; cursor: pointer; font-weight: bold; }
        .btn-blue { background-color: #2196F3; } .btn-red { background-color: #F44336; } .btn-green { background-color: #4CAF50; }
        .hidden { display: none !important; }
        .big-number { font-size: 60px; font-weight: bold; color: #ffeb3b; margin: 20px 0; }
        input[type=range] { width: 100%; margin: 30px 0; cursor: pointer; }
        
        /* ç°¡æ˜“ãƒãƒ£ãƒƒãƒˆ/ãƒ­ã‚° */
        #status-log { color: #aaa; font-size: 12px; margin-bottom: 10px; min-height: 20px; }

        /* çµæœãƒãƒ¼ */
        .result-viz-container { position: relative; width: 100%; height: 60px; background-color: #444; border-radius: 8px; margin: 15px 0; overflow: hidden; }
        .zone { position: absolute; height: 100%; top: 0; opacity: 0.8; }
        .zone-2 { background-color: #4fc3f7; } .zone-3 { background-color: #ffd740; } .zone-4 { background-color: #ff6e40; }
        .guess-pin { position: absolute; top: 0; width: 4px; height: 100%; background-color: #fff; z-index: 10; box-shadow: 0 0 4px #000; transition: left 0.1s; }
        .target-pin { position: absolute; top: 0; width: 2px; height: 100%; background-color: #ffeb3b; z-index: 5; opacity: 0.5; border-left: 1px dashed #000; }
        
        /* ãƒ”ãƒ¼ã‚¯ãƒœã‚¿ãƒ³ï¼ˆè‡ªåˆ†ã ã‘è¦‹ã‚‹ï¼‰ */
        .peek-btn { background: #333; border: 1px solid #777; color: #aaa; padding: 5px 10px; border-radius: 5px; margin-bottom: 10px; cursor: pointer; }
        .peek-content { filter: blur(10px); transition: filter 0.3s; }
        .peek-active { filter: blur(0); }
    </style>
</head>
<body>

    <div id="screen-login" class="card">
        <h1>Wavelength Online</h1>
        <p>åˆè¨€è‘‰ã‚’æ±ºã‚ã¦å‹é”ã¨ç¹‹ãŒã‚ã†</p>
        <input type="text" id="room-id" placeholder="åˆè¨€è‘‰ (ä¾‹: apple)" style="padding:10px; font-size:20px; width:80%; text-align:center; margin-bottom:20px;">
        <button class="btn btn-green" onclick="joinRoom()">éƒ¨å±‹ã«å…¥ã‚‹ / ä½œã‚‹</button>
    </div>

    <div id="screen-game" class="card hidden">
        <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa; margin-bottom:10px;">
            <span>Room: <span id="display-room-id" style="color:#fff;"></span></span>
            <span id="connection-status">â— æ¥ç¶šä¸­</span>
        </div>
        
        <div style="background:#333; padding:10px; border-radius:8px; display:flex; justify-content:space-between; margin-bottom:15px;">
            <div style="text-align:center; width:45%;">
                <div style="font-size:12px; color:#2196F3;">TEAM A</div>
                <div id="score-a" style="font-size:24px; font-weight:bold;">0</div>
            </div>
            <div style="font-size:20px; line-height:50px;">VS</div>
            <div style="text-align:center; width:45%;">
                <div style="font-size:12px; color:#F44336;">TEAM B</div>
                <div id="score-b" style="font-size:24px; font-weight:bold;">0</div>
            </div>
        </div>

        <p id="status-text" style="font-size:18px; font-weight:bold; color:#ffeb3b;">å¾…æ©Ÿä¸­...</p>

        <div id="phase-psychic" class="hidden">
            <p style="font-size:14px; color:#aaa;">å‡ºé¡Œè€…ã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æ•°å€¤ã‚’ç¢ºèªã—ã€<br>ãƒ’ãƒ³ãƒˆã‚’å£é ­/ãƒãƒ£ãƒƒãƒˆã§ä¼ãˆã¦ãã ã•ã„</p>
            
            <button class="peek-btn" onmousedown="revealTarget(true)" onmouseup="revealTarget(false)" ontouchstart="revealTarget(true)" ontouchend="revealTarget(false)">
                æŠ¼ã—ã¦ã„ã‚‹é–“ã ã‘ç­”ãˆã‚’è¦‹ã‚‹<br>(è‡ªåˆ†ã ã‘ã«è¦‹ãˆã¾ã™)
            </button>
            <div id="secret-target" class="big-number peek-content">??</div>
            
            <button class="btn" onclick="nextPhase('GUESS')">ãƒ’ãƒ³ãƒˆã‚’å‡ºã—ãŸ (å›ç­”ã¸)</button>
        </div>

        <div id="phase-guess" class="hidden">
            <p>ãƒãƒ¼ãƒ ã§ç›¸è«‡ã—ã¦ä½ç½®ã‚’æ±ºã‚ã‚ˆã†ï¼</p>
            <div class="big-number" id="guess-display">50</div>
            <input type="range" id="slider" min="0" max="100" value="50" oninput="onSliderChange(this.value)" onchange="onSliderChange(this.value)">
            <button class="btn" onclick="nextPhase('COUNTER')">äºˆæƒ³ã‚’ç¢ºå®šã™ã‚‹</button>
        </div>

        <div id="phase-counter" class="hidden">
            <p>æ•µãƒãƒ¼ãƒ ã®ãƒãƒ£ãƒ³ã‚¹ï¼<br>æ­£è§£ã¯äºˆæƒ³(<span id="locked-guess"></span>)ã‚ˆã‚Š...</p>
            <div style="display:flex; justify-content:space-between;">
                <button class="btn btn-choice" style="width:48%" onclick="submitCounter('Left')">â¬…ï¸ å·¦</button>
                <button class="btn btn-choice" style="width:48%" onclick="submitCounter('Right')">å³ â¡ï¸</button>
            </div>
            <p style="font-size:12px; color:#aaa; margin-top:10px;">â€»èª¤å·®0ãªã‚‰å¼·åˆ¶ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™</p>
        </div>

        <div id="phase-result" class="hidden">
            <div class="result-viz-container" id="viz-bar"></div>
            <div id="result-details" style="text-align:left; font-size:14px; line-height:1.6;"></div>
            <button class="btn btn-green" onclick="startNewRound()">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸</button>
        </div>

        <div id="phase-win" class="hidden">
            <h1>WINNER!</h1>
            <div style="font-size:60px;">ğŸ†</div>
            <h2 id="winner-name">TEAM A</h2>
            <button class="btn btn-red" onclick="resetGame()">ãƒªã‚»ãƒƒãƒˆã—ã¦å†æˆ¦</button>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜… ã“ã“ã« Firebase ã®è¨­å®šã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â˜…â˜…â˜…
        const firebaseConfig = {
  apiKey: "AIzaSyDTnNp8ObeesaXjjBQqlC1MPLPh8V5SfPM",
  authDomain: "wavelength-online-2c27b.firebaseapp.com",
  databaseURL: "https://wavelength-online-2c27b-default-rtdb.firebaseio.com",
  projectId: "wavelength-online-2c27b",
  storageBucket: "wavelength-online-2c27b.firebasestorage.app",
  messagingSenderId: "1057840306391",
  appId: "1:1057840306391:web:432e632f9af1f286643892"
};
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

        // FirebaseåˆæœŸåŒ–
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();

        let roomId = "";
        let gameState = {};
        const WIN_SCORE = 10;
        const TEAM_CONF = { A: {color:"#2196F3"}, B: {color:"#F44336"} };
        const RANGES = { w4: 2, w3: 5, w2: 8 };

        // éƒ¨å±‹ã«å…¥ã‚‹
        function joinRoom() {
            const input = document.getElementById('room-id').value;
            if(!input) return alert("åˆè¨€è‘‰ã‚’å…¥ã‚Œã¦ãã ã•ã„");
            roomId = "wavelength_" + input; // è­˜åˆ¥å­ã‚’ã¤ã‘ã‚‹
            
            document.getElementById('display-room-id').innerText = input;
            document.getElementById('screen-login').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç›£è¦–ã‚’é–‹å§‹ (ã“ã‚ŒãŒåŒæœŸã®ã‚­ãƒ¢ã§ã™ï¼)
            db.ref(roomId).on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    gameState = data;
                    renderGame(); // ç”»é¢ã‚’æ›´æ–°
                } else {
                    // éƒ¨å±‹ãŒã¾ã ãªã„å ´åˆã¯åˆæœŸåŒ–
                    startNewRound(true);
                }
            });
        }

        // çŠ¶æ…‹ã‚’DBã«ä¿å­˜ã™ã‚‹é–¢æ•°
        function updateDB(updates) {
            db.ref(roomId).update(updates);
        }

        // æ–°ã—ã„ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’é–‹å§‹ (åˆæœŸåŒ–ã‚‚å…¼ã­ã‚‹)
        function startNewRound(fullReset = false) {
            let nextTeam = 'A';
            let scores = { A: 0, B: 0 };
            let round = 1;

            if (!fullReset && gameState.scores) {
                scores = gameState.scores;
                round = gameState.round + 1;
                nextTeam = gameState.currentTeam === 'A' ? 'B' : 'A';
            } else {
                // å®Œå…¨ãƒªã‚»ãƒƒãƒˆæ™‚ã¯ãƒ©ãƒ³ãƒ€ãƒ å…ˆæ”»
                nextTeam = Math.random() < 0.5 ? 'A' : 'B';
            }

            updateDB({
                phase: 'PSYCHIC', // PSYCHIC, GUESS, COUNTER, RESULT, WIN
                currentTeam: nextTeam,
                scores: scores,
                round: round,
                target: Math.floor(Math.random() * 101),
                guess: 50,
                counterGuess: null,
                resultData: null
            });
        }

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œã®åŒæœŸ
        function onSliderChange(val) {
            // é€£æ‰“é˜²æ­¢ã®ãŸã‚ã€å°‘ã—é–“å¼•ã„ã¦ã‚‚ã„ã„ãŒã€ä»Šå›ã¯ç›´æ¥é€ä¿¡
            updateDB({ guess: parseInt(val) });
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºé€²è¡Œ
        function nextPhase(next) {
            if (next === 'COUNTER') {
                // èª¤å·®0åˆ¤å®šï¼ˆå³çµæœã¸ï¼‰
                let diff = Math.min(Math.abs(gameState.target - gameState.guess), 100 - Math.abs(gameState.target - gameState.guess));
                if (diff === 0) {
                    submitCounter(null); // å¼·åˆ¶ã‚¹ã‚­ãƒƒãƒ—
                    return;
                }
            }
            updateDB({ phase: next });
        }

        // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼é€ä¿¡ã¨çµæœè¨ˆç®—
        function submitCounter(direction) {
            // çµæœè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãªã®ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¨ˆç®—ã—ã¦DBæ›´æ–°ï¼‰
            const target = gameState.target;
            const guess = gameState.guess;
            const active = gameState.currentTeam;
            const inactive = active === 'A' ? 'B' : 'A';

            let diff = Math.abs(target - guess);
            let finalDiff = Math.min(diff, 100 - diff);

            let activePts = 0;
            if (finalDiff === 0) activePts = 5;
            else if (finalDiff <= RANGES.w4) activePts = 4;
            else if (finalDiff <= RANGES.w3) activePts = 3;
            else if (finalDiff <= RANGES.w2) activePts = 2;

            // æ•µã®ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—
            let inactivePts = 0;
            let resultMsg = "";
            
            if (finalDiff === 0) {
                resultMsg = "å®Œå…¨ä¸€è‡´ã®ãŸã‚ãƒœãƒ¼ãƒŠã‚¹ãªã—";
            } else {
                // æ­£è§£æ–¹å‘
                let d = target - guess;
                if (d > 50) d -= 100;
                if (d < -50) d += 100;
                let trueDir = d > 0 ? 'Right' : 'Left';
                
                if (direction === trueDir) {
                    inactivePts = 1;
                    resultMsg = "æ•µãƒãƒ¼ãƒ èª­ã¿é€šã‚Šï¼ (+1ç‚¹)";
                } else {
                    resultMsg = "æ•µãƒãƒ¼ãƒ äºˆæƒ³ãƒã‚ºãƒ¬...";
                }
            }

            let newScores = { ...gameState.scores };
            newScores[active] += activePts;
            newScores[inactive] += inactivePts;

            // DBæ›´æ–°
            updateDB({
                scores: newScores,
                counterGuess: direction,
                resultData: { activePts, inactivePts, finalDiff, msg: resultMsg },
                phase: (newScores.A >= WIN_SCORE || newScores.B >= WIN_SCORE) ? 'WIN' : 'RESULT'
            });
        }

        function resetGame() {
            startNewRound(true);
        }

        // ã‚µã‚¤ã‚­ãƒƒã‚¯ã®ç­”ãˆã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ã¿è¡¨ç¤º
        function revealTarget(show) {
            const el = document.getElementById('secret-target');
            if (show) {
                el.innerText = gameState.target;
                el.classList.add('peek-active');
            } else {
                el.classList.remove('peek-active');
                setTimeout(() => el.innerText = "??", 300); // éš ã—ã¦ã‹ã‚‰æ–‡å­—æˆ»ã™
            }
        }

        // â˜…â˜…â˜… æç”»é–¢æ•° (DBãŒå¤‰ã‚ã‚‹ãŸã³ã«å‘¼ã°ã‚Œã‚‹) â˜…â˜…â˜…
        function renderGame() {
            const g = gameState;
            const tm = TEAM_CONF[g.currentTeam];
            const activeName = `TEAM ${g.currentTeam}`;
            
            // ã‚¹ã‚³ã‚¢æ›´æ–°
            document.getElementById('score-a').innerText = g.scores.A;
            document.getElementById('score-b').innerText = g.scores.B;

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
            const statusEl = document.getElementById('status-text');
            statusEl.style.color = tm.color;
            
            // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            ['psychic', 'guess', 'counter', 'result', 'win'].forEach(id => {
                document.getElementById('phase-' + id).classList.add('hidden');
            });

            if (g.phase === 'PSYCHIC') {
                statusEl.innerText = `${activeName} ã®å‡ºé¡Œã‚¿ãƒ¼ãƒ³`;
                document.getElementById('phase-psychic').classList.remove('hidden');
            
            } else if (g.phase === 'GUESS') {
                statusEl.innerText = `${activeName} ãŒç›¸è«‡ä¸­...`;
                document.getElementById('phase-guess').classList.remove('hidden');
                document.getElementById('guess-display').innerText = g.guess;
                document.getElementById('slider').value = g.guess;
                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®è‰²ã‚’å¤‰ãˆã‚‹
                document.getElementById('slider').style.accentColor = tm.color;

            } else if (g.phase === 'COUNTER') {
                const enemy = g.currentTeam === 'A' ? 'TEAM B' : 'TEAM A';
                statusEl.innerText = `${enemy} ã®ãƒãƒ£ãƒ³ã‚¹ï¼`;
                document.getElementById('phase-counter').classList.remove('hidden');
                document.getElementById('locked-guess').innerText = g.guess;

            } else if (g.phase === 'RESULT') {
                statusEl.innerText = "çµæœç™ºè¡¨";
                document.getElementById('phase-result').classList.remove('hidden');
                drawVisualResult(g.target, g.guess, tm.color);
                
                let html = `
                    <p>æ­£è§£: <strong style="color:#ffeb3b">${g.target}</strong> (èª¤å·® ${g.resultData.finalDiff})</p>
                    <p>${activeName}: <strong>+${g.resultData.activePts}ç‚¹</strong></p>
                    <p>ãƒãƒ£ãƒ³ã‚¹: ${g.counterGuess === 'Right' ? 'å³' : (g.counterGuess === 'Left' ? 'å·¦' : 'ãªã—')} â†’ ${g.resultData.msg}</p>
                `;
                document.getElementById('result-details').innerHTML = html;

            } else if (g.phase === 'WIN') {
                document.getElementById('phase-win').classList.remove('hidden');
                const winner = g.scores.A >= WIN_SCORE ? 'TEAM A' : 'TEAM B';
                document.getElementById('winner-name').innerText = winner;
                document.getElementById('winner-name').style.color = TEAM_CONF[winner.slice(-1)].color;
            }
        }

        // çµæœæç”» (ä»¥å‰ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯)
        function drawVisualResult(target, guess, color) {
            const container = document.getElementById('viz-bar');
            container.innerHTML = ''; 
            function createZone(w, cls) {
                let s = target - w, e = target + w;
                drawR(s, e, cls);
                if (s < 0) drawR(100+s, 100, cls);
                if (e > 100) drawR(0, e-100, cls);
            }
            function drawR(l, r, cls) {
                let div = document.createElement('div');
                div.className = 'zone ' + cls;
                div.style.left = Math.max(0,l)+'%'; div.style.width = (Math.min(100,r)-Math.max(0,l))+'%';
                container.appendChild(div);
            }
            createZone(8, 'zone-2'); createZone(5, 'zone-3'); createZone(2, 'zone-4');
            
            let pin = document.createElement('div');
            pin.className = 'guess-pin';
            pin.style.left = guess + '%';
            pin.style.backgroundColor = color;
            container.appendChild(pin);

            let tPin = document.createElement('div');
            tPin.className = 'target-pin';
            tPin.style.left = target + '%';
            container.appendChild(tPin);
        }
    </script>
</body>
</html>
